<!DOCTYPE HTML>
<html>
    <head>
      <% include ../include/commonHead %>
        <style>
            body { margin: 0}
            canvas { width:100%; height:100% }
        </style>
    </head>
    <body>
          <script src="/js/seedrandom.min.js"></script>
          <script src="/js/mybus.js"></script>
          <script src="/src/10-Optionen.js"></script>
          <% if (devMode) { %>
            <script src="/src/12-DeveloperMode.js"></script>
          <% } %>
          <% if (fightMode) { %>
            <script src="/src/14-FightMode.js"></script>
          <% } %>
          
          <% include ../include/simRessources %>
          
          <script src="/src/View/00-View.js"></script>
          <script src="/src/View/10-Pulse.js"></script>
          <script src="/src/View/12-UI.js"></script>
          
          <script>
          
          var View = AntIT._view
          
          
          View.Pulse.getBus().on('start', function(){
            View.Pulse.Init()
            
            View.Pulse.setFps(undefined)
            
            function tick(){
              for (var i = 0; i < 300; i++) {
                if (!View.Pulse.Tick())
                  return
              }
              setTimeout(tick, 0)
            }
            
            tick()
          
          })
          
          </script>
          
          <!--<script src="/src/View/99-Seal.js"></script>-->
        
      <div class="container">
        <h1>Headless AntIT! Simulator</h1>
        <div id="loading" style="font-size:2em;color:white;">
	        <span class="label label-default" id="intro-text">Simulationsfehler!</span>
        </div>
        <div style="position: absolute; z-index: 3; right: 50px; top: 50px;font-size:1em;color:white;background-color:rgba(255,255,255,0.5);">
	        <a href="/wettbewerb" class="btn btn-primary">zur√ºck</a>
        </div>
        <br>
        
        <% for (var i = 1; i <= repeat; i++) { %>
        <div id="hud<%=i%>"></div>
        <% } %>
        <br>
        <div id="batchstat"></div><br>
        <div id="stats"></div>
        <br><br><br>
      </div>
          
   <script>     
<%

  function btoa(str) {
    var buffer
      ;

    if (str instanceof Buffer) {
      buffer = str;
    } else {
      buffer = new Buffer(str.toString(), 'binary');
    }

    return buffer.toString('base64');
  }


  var atLeastOnFile = false;
  if (code) {
    code.forEach(function(c){
      atLeastOnFile = true;
      if (devMode) {
        %>(function(){
        


<%-c.code%>


        
        })();<%
      } else {
        var exportCode = btoa('(function(){' + c.code + '})();')
        %>eval(atob("<%-exportCode%>"));
        <%
      }
    });
  }
  

%>document.getElementById("intro-text").innerHTML = "Dateien werden geladen ...";<%

  if (!atLeastOnFile) {%>
    document.getElementById('intro-text').innerHTML = "Keine Ameise geladen!"
    throw "Keine Ameise geladen!"
  <%} 

%>

function start(){
  if (counter <= <%=repeat%>) {
    var hud = "hud" + counter
    document.getElementById("batchstat").innerHTML = counter + " von <%=repeat%>"
    counter++
    var autoscroll = false
    if ((window.innerHeight + window.pageYOffset) >= document.body.offsetHeight - 30) {
        autoscroll = true
    }
    AntIT.StarteSimulation(null, null, "<%-seed%>", hud)
    if (autoscroll) window.scrollTo(0,document.body.scrollHeight);
  }
}
var counter = 1
var stats = []
View.Pulse.getBus().on('submit', function(){
    var points = View.Sim.getPoints().split(',')
    if (stats.length == 0)
      stats = points
    else {
      for (var i = 0; i < points.length; i++) {
        stats[i] = parseInt(stats[i]) + parseInt(points[i])
      }
    }
    document.getElementById("stats").innerHTML = stats.map(function(p){
      return "durchschnittlich " + Math.round(p/(counter-1)) + " Punkte"
    }).join('<br>')
    setTimeout(start,0)
})
start()

</script>
    </body>
</html>

